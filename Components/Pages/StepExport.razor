@* Steg 4: Sammanfattning & Export *@
@inject ExcelGeneratorService ExcelService
@inject AzureDevOpsService DevOpsService
@inject IJSRuntime JS

<!-- Sammanfattning Header -->
<div class="summary-header">
    <div class="summary-header-content">
        <h1>üìã Projektsammanfattning</h1>
        <p class="subtitle">Granska all projektinformation innan export</p>
    </div>
    <div class="summary-header-stats">
        <div class="stat-item">
            <span class="stat-value">@Data.BudgetHours</span>
            <span class="stat-label">Budgettimmar</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">@GetTotalEstimatedHours()</span>
            <span class="stat-label">Estimerat</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">@GetTotalWorkItems()</span>
            <span class="stat-label">Work Items</span>
        </div>
    </div>
</div>

<!-- Sammanfattning Grid -->
<div class="summary-grid-container">
    <!-- Projektinfo -->
    <div class="summary-card">
        <div class="summary-card-header">
            <span class="summary-card-icon">üè¢</span>
            <h3>Projektinfo</h3>
        </div>
        <div class="summary-card-content">
            <div class="summary-row">
                <span class="summary-label">Kund</span>
                <span class="summary-value">@(string.IsNullOrEmpty(Data.CustomerName) ? "‚Äî" : Data.CustomerName)</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Projekttitel</span>
                <span class="summary-value">@(string.IsNullOrEmpty(Data.ProjectTitle) ? "‚Äî" : Data.ProjectTitle)</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Beskrivning</span>
                <span class="summary-value description">@(string.IsNullOrEmpty(Data.ProjectDescription) ? "‚Äî" : Data.ProjectDescription)</span>
            </div>
        </div>
    </div>

    <!-- Tidsplan -->
    <div class="summary-card">
        <div class="summary-card-header">
            <span class="summary-card-icon">üìÖ</span>
            <h3>Tidsplan</h3>
        </div>
        <div class="summary-card-content">
            <div class="summary-row">
                <span class="summary-label">Projektstart</span>
                <span class="summary-value">@(Data.ProjectStart.HasValue ? Data.ProjectStart.Value.ToString("yyyy-MM-dd") : "Ej satt")</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Go-live</span>
                <span class="summary-value">@(Data.GoLive.HasValue ? Data.GoLive.Value.ToString("yyyy-MM-dd") : "Ej satt")</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Veckor</span>
                <span class="summary-value">@Data.EstimatedWeeks veckor</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Tempo</span>
                <span class="summary-value">@Data.WeeklyPace h/vecka</span>
            </div>
            @if (Data.Milestones.Any())
            {
                <div class="summary-row">
                    <span class="summary-label">Milstolpar</span>
                    <span class="summary-value">@Data.Milestones.Count st</span>
                </div>
            }
        </div>
    </div>

    <!-- Projektgrupp -->
    <div class="summary-card">
        <div class="summary-card-header">
            <span class="summary-card-icon">üë•</span>
            <h3>Projektgrupp</h3>
        </div>
        <div class="summary-card-content">
            <div class="team-summary">
                <div class="team-group">
                    <span class="team-badge exsitec">Exsitec</span>
                    <span class="team-count">@Data.ExsitecMembers.Count(m => !string.IsNullOrEmpty(m.Name)) personer</span>
                </div>
                @foreach (var member in Data.ExsitecMembers.Where(m => !string.IsNullOrEmpty(m.Name)).Take(5))
                {
                    <div class="team-member-mini">
                        <span class="member-name">@member.Name</span>
                        <span class="member-role">@member.Role</span>
                    </div>
                }
                @if (Data.ExsitecMembers.Count(m => !string.IsNullOrEmpty(m.Name)) > 5)
                {
                    <span class="more-members">+@(Data.ExsitecMembers.Count(m => !string.IsNullOrEmpty(m.Name)) - 5) fler...</span>
                }
            </div>
            <div class="team-summary" style="margin-top: 0.75rem;">
                <div class="team-group">
                    <span class="team-badge customer">Kund</span>
                    <span class="team-count">@Data.CustomerMembers.Count(m => !string.IsNullOrEmpty(m.Name)) personer</span>
                </div>
                @foreach (var member in Data.CustomerMembers.Where(m => !string.IsNullOrEmpty(m.Name)).Take(3))
                {
                    <div class="team-member-mini">
                        <span class="member-name">@member.Name</span>
                        <span class="member-role">@member.Role</span>
                    </div>
                }
                @if (Data.CustomerMembers.Count(m => !string.IsNullOrEmpty(m.Name)) > 3)
                {
                    <span class="more-members">+@(Data.CustomerMembers.Count(m => !string.IsNullOrEmpty(m.Name)) - 3) fler...</span>
                }
            </div>
        </div>
    </div>

    <!-- Risker -->
    @if (Data.IncludeRisks)
    {
        <div class="summary-card">
            <div class="summary-card-header">
                <span class="summary-card-icon">‚ö†Ô∏è</span>
                <h3>Risker</h3>
            </div>
            <div class="summary-card-content">
                <div class="summary-row">
                    <span class="summary-label">Valda risker</span>
                    <span class="summary-value">@Data.Risks.Count(r => r.Selected) av @Data.Risks.Count</span>
                </div>
                @foreach (var risk in Data.Risks.Where(r => r.Selected).Take(3))
                {
                    <div class="risk-mini">
                        <span class="risk-title">@risk.Title</span>
                        <span class="risk-level risk-@GetRiskLevel(risk)">@risk.RiskValue</span>
                    </div>
                }
                @if (Data.Risks.Count(r => r.Selected) > 3)
                {
                    <span class="more-members">+@(Data.Risks.Count(r => r.Selected) - 3) fler risker...</span>
                }
            </div>
        </div>
    }
</div>

<!-- DevOps-struktur √∂versikt -->
<div class="card">
    <div class="card-header-flex">
        <div>
            <h2>üèóÔ∏è DevOps-struktur</h2>
            <p class="subtitle">√ñversikt av work items som ska skapas</p>
        </div>
        <div class="structure-stats">
            <span class="structure-stat"><strong>@Data.DevOpsStructure.Epics.Count</strong> Epics</span>
            <span class="structure-stat"><strong>@Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)</strong> Features</span>
            <span class="structure-stat"><strong>@Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))</strong> Requirements</span>
            <span class="structure-stat"><strong>@Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)))</strong> Tasks</span>
        </div>
    </div>
    
    <div class="structure-preview">
        @{
            var epicsToShow = showAllEpics ? Data.DevOpsStructure.Epics : Data.DevOpsStructure.Epics.Take(3).ToList();
        }
        @foreach (var epic in epicsToShow)
        {
            <div class="epic-preview">
                <div class="epic-preview-header">
                    <span class="wi-badge wi-epic">Epic</span>
                    <span class="epic-title">@epic.Title</span>
                    <span class="epic-hours">@GetEpicHours(epic) h</span>
                </div>
                <div class="epic-preview-features">
                    @{
                        var featuresToShow = showAllEpics ? epic.Features : epic.Features.Take(2).ToList();
                    }
                    @foreach (var feature in featuresToShow)
                    {
                        <span class="feature-chip">@feature.Title (@GetFeatureHours(feature) h)</span>
                    }
                    @if (!showAllEpics && epic.Features.Count > 2)
                    {
                        <span class="feature-chip more">+@(epic.Features.Count - 2) fler</span>
                    }
                </div>
            </div>
        }
        @if (Data.DevOpsStructure.Epics.Count > 3)
        {
            <button class="btn-expand" @onclick="() => showAllEpics = !showAllEpics">
                @if (showAllEpics)
                {
                    <span>‚ñ≤ Visa mindre</span>
                }
                else
                {
                    <span>‚ñº Visa alla @Data.DevOpsStructure.Epics.Count epics</span>
                }
            </button>
        }
    </div>
</div>

<!-- Export Actions -->
<div class="card export-actions-card">
    <h2>üì§ Exportera</h2>
    <p class="subtitle">Ladda ner DevOps-struktur eller skicka direkt till Azure DevOps</p>

    <div class="export-simple-grid">
        <!-- CSV Download -->
        <div class="export-option">
            <div class="export-option-icon">üìÑ</div>
            <div class="export-option-content">
                <h3>Ladda ner CSV</h3>
                <p>Exportera DevOps-strukturen som CSV-fil f√∂r import eller analys</p>
            </div>
            <button class="btn btn-secondary" @onclick="DownloadWorkItemsCsv">
                Ladda ner CSV
            </button>
        </div>

        <!-- DevOps Upload -->
        <div class="export-option highlight">
            <div class="export-option-icon">üöÄ</div>
            <div class="export-option-content">
                <h3>Ladda upp till DevOps</h3>
                <p>Skapa work items direkt i Azure DevOps Boards</p>
            </div>
            
            @if (!isImporting && importResults == null)
            {
                <button class="btn btn-primary" @onclick="ImportToDevOps">
                    Ladda upp @GetTotalWorkItems() work items
                </button>
            }

            @if (isImporting && importProgress != null)
            {
                <div class="import-progress">
                    <div class="progress-bar-custom">
                        <div class="progress-fill" style="width: @(importProgress.Total > 0 ? (int)(100.0 * importProgress.Current / importProgress.Total) : 0)%"></div>
                    </div>
                    <p class="progress-text">@importProgress.Message (@importProgress.Current / @importProgress.Total)</p>
                </div>
            }

            @if (importResults != null)
            {
                <div class="import-success">
                    <span class="success-icon">‚úÖ</span>
                    <span>@importResults.Count work items skapade!</span>
                    <a href="https://dev.azure.com/@Data.DevOpsOrg/@Data.DevOpsProject/_backlogs" target="_blank" class="btn btn-outline btn-sm">
                        √ñppna Backlog
                    </a>
                    <button class="btn btn-ghost btn-sm" @onclick="ResetImport">Ladda upp igen</button>
                </div>
            }

            @if (importError != null)
            {
                <div class="import-error">
                    <span class="error-icon">‚ùå</span>
                    <span>@importError</span>
                    <button class="btn btn-ghost btn-sm" @onclick="ResetImport">F√∂rs√∂k igen</button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public ProjectData Data { get; set; } = default!;

    private bool isImporting;
    private ProgressInfo? importProgress;
    private List<PushResult>? importResults;
    private string? importError;
    private bool showAllEpics = false;

    private int GetTotalWorkItems() => Data.DevOpsStructure.Epics.Count
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)));

    private int GetTotalEstimatedHours() => Data.DevOpsStructure.Epics
        .Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Estimate)));

    private int GetEpicHours(Epic epic) => epic.Features.Sum(f => f.Requirements.Sum(r => r.Estimate));
    
    private int GetFeatureHours(Feature feature) => feature.Requirements.Sum(r => r.Estimate);

    private string GetRiskLevel(Risk risk) => risk.RiskValue switch
    {
        >= 12 => "high",
        >= 6 => "medium",
        _ => "low"
    };

    private async Task ImportToDevOps()
    {
        isImporting = true;
        importResults = null;
        importError = null;

        try
        {
            importResults = await DevOpsService.PushToDevOpsAsync(Data, p =>
            {
                importProgress = p;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            importError = ex.Message;
        }
        finally
        {
            isImporting = false;
        }
    }

    private void ResetImport()
    {
        importResults = null;
        importProgress = null;
        importError = null;
    }

    // CSV Export methods
    private async Task DownloadWorkItemsCsv()
    {
        var csv = GenerateWorkItemsCsv();
        await DownloadCsvFile($"WorkItems_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadTeamCsv()
    {
        var csv = GenerateTeamCsv();
        await DownloadCsvFile($"Team_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadRisksCsv()
    {
        var csv = GenerateRisksCsv();
        await DownloadCsvFile($"Risker_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadAllCsv()
    {
        await DownloadWorkItemsCsv();
        await Task.Delay(300);
        await DownloadTeamCsv();
        if (Data.IncludeRisks)
        {
            await Task.Delay(300);
            await DownloadRisksCsv();
        }
    }

    private string GenerateWorkItemsCsv()
    {
        var lines = new List<string> { "ID,Work Item Type,Order,Area Path,Title 1,Title 2,Title 3,Title 4,Title 5,Description,State,Effort,Original Estimate,Remaining" };
        var areaPath = Data.AreaPath;
        
        // First line: Root Epic with project title
        lines.Add($",Epic,2829,{areaPath},{EscapeCsv(Data.MainTitle)},,,,,,Proposed,,,");
        
        foreach (var epic in Data.DevOpsStructure.Epics)
        {
            // Epic as Title 2
            lines.Add($",Epic,,{areaPath},,{EscapeCsv(epic.Title)},,,,,,Proposed,,,");
            
            foreach (var feature in epic.Features)
            {
                // Feature as Title 3, with Effort
                var featureEffort = feature.Requirements.Sum(r => r.Estimate);
                lines.Add($",Feature,,{areaPath},,,{EscapeCsv(feature.Title)},,,,,Proposed,{featureEffort},,");
                
                foreach (var req in feature.Requirements)
                {
                    // Requirement as Title 4, with Original Estimate and Remaining
                    lines.Add($",Requirement,,{areaPath},,,,{EscapeCsv(req.Title)},,,Proposed,,{req.Estimate},{req.Estimate}");
                    
                    foreach (var task in req.Tasks)
                    {
                        // Task as Title 5
                        lines.Add($",Task,,{areaPath},,,,,{EscapeCsv(task.Title)},,Proposed,,,");
                    }
                }
            }
        }
        
        return string.Join("\n", lines);
    }

    private string GenerateTeamCsv()
    {
        var lines = new List<string> { "Type,Name,Role,Group,Email,Phone,Comment" };
        
        foreach (var member in Data.ExsitecMembers)
        {
            lines.Add($"Exsitec,\"{EscapeCsv(member.Name)}\",\"{EscapeCsv(member.Role)}\",\"{EscapeCsv(member.Group)}\",\"{EscapeCsv(member.Email)}\",\"{EscapeCsv(member.Phone)}\",");
        }
        
        foreach (var member in Data.CustomerMembers)
        {
            lines.Add($"Kund,\"{EscapeCsv(member.Name)}\",\"{EscapeCsv(member.Role)}\",,\"{EscapeCsv(member.Email)}\",\"{EscapeCsv(member.Phone)}\",\"{EscapeCsv(member.Comment)}\"");
        }
        
        return string.Join("\n", lines);
    }

    private string GenerateRisksCsv()
    {
        var lines = new List<string> { "Title,Category,Probability,Impact,RiskValue,Priority,Owner,Strategy" };
        
        foreach (var risk in Data.Risks.Where(r => r.Selected))
        {
            lines.Add($"\"{EscapeCsv(risk.Title)}\",\"{EscapeCsv(risk.Category)}\",{risk.Probability},{risk.Impact},{risk.RiskValue},\"{risk.Priority}\",\"{EscapeCsv(risk.Owner)}\",\"{EscapeCsv(risk.Strategy)}\"");
        }
        
        return string.Join("\n", lines);
    }

    private string EscapeCsv(string? value) => value?.Replace("\"", "\"\"") ?? "";

    private async Task DownloadCsvFile(string filename, string content)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        await JS.InvokeVoidAsync("downloadFile", filename, "text/csv", bytes);
    }

    // Excel Export methods
    private async Task DownloadDevOpsImport()
    {
        var bytes = ExcelService.GenerateDevOpsImport(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"AzureDevopsImportStruktur_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadChecklist()
    {
        var bytes = ExcelService.GenerateChecklist(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Checklista_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadProjektverktyg()
    {
        var bytes = ExcelService.GenerateProjektverktyg(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Projektverktyg_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadAll()
    {
        await DownloadDevOpsImport();
        await Task.Delay(300);
        await DownloadChecklist();
        await Task.Delay(300);
        await DownloadProjektverktyg();
    }
}
