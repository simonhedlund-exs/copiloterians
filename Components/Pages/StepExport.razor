@* Steg 6: Exportera *@
@inject ExcelGeneratorService ExcelService
@inject AzureDevOpsService DevOpsService
@inject IJSRuntime JS

<div class="card">
    <h2>Sammanfattning</h2>
    <p class="subtitle">Granska projektinformationen innan export</p>

    <div class="summary-section">
        <h3>Projektinfo</h3>
        <dl class="summary-grid">
            <dt>Kund</dt><dd>@Data.CustomerName</dd>
            <dt>Projekt</dt><dd>@Data.MainTitle</dd>
            <dt>Area Path</dt><dd>@Data.AreaPath</dd>
            @if (Data.ProjectStart.HasValue)
            {
                <dt>Projektstart</dt><dd>@Data.ProjectStart.Value.ToString("yyyy-MM-dd")</dd>
            }
            @if (Data.GoLive.HasValue)
            {
                <dt>Go-live</dt><dd>@Data.GoLive.Value.ToString("yyyy-MM-dd")</dd>
            }
            <dt>Budget</dt><dd>@Data.BudgetHours h (@Data.EstimatedWeeks veckor)</dd>
        </dl>
    </div>

    <div class="summary-section">
        <h3>Projektgrupp</h3>
        <p>Exsitec: @Data.ExsitecMembers.Count st | Kund: @Data.CustomerMembers.Count st</p>
    </div>

    <div class="summary-section">
        <h3>Risker</h3>
        <p>@Data.Risks.Count(r => r.Selected) av @Data.Risks.Count risker valda</p>
    </div>

    <div class="summary-section">
        <h3>DevOps-struktur</h3>
        @{
            var totalItems = Data.DevOpsStructure.Epics.Count
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)));
        }
        <p>@Data.DevOpsStructure.Epics.Count Epics, @totalItems totalt work items</p>
    </div>
</div>

<div class="card">
    <h2>Ladda ner Excel-filer</h2>
    <p class="subtitle">Generera Excel-dokument baserade pÃ¥ dina projektuppgifter</p>

    <div class="export-grid">
        <div class="export-card">
            <div class="export-icon">ðŸ“‹</div>
            <h3>DevOps Import</h3>
            <p>Importstruktur fÃ¶r Azure DevOps med alla work items</p>
            <button class="btn btn-secondary" @onclick="DownloadDevOpsImport">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">âœ…</div>
            <h3>Checklista</h3>
            <p>Projektchecklista med alla faser och aktiviteter</p>
            <button class="btn btn-secondary" @onclick="DownloadChecklist">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">ðŸ“Š</div>
            <h3>Projektverktyg</h3>
            <p>Komplett projektverktyg med alla flikar</p>
            <button class="btn btn-secondary" @onclick="DownloadProjektverktyg">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">ðŸ“¦</div>
            <h3>Alla filer</h3>
            <p>Ladda ner alla tre Excel-filer pÃ¥ en gÃ¥ng</p>
            <button class="btn btn-primary" @onclick="DownloadAll">Ladda ner alla</button>
        </div>
    </div>
</div>

<div class="card">
    <h2>Pusha till Azure DevOps</h2>
    <p class="subtitle">Skapa work items direkt i Azure DevOps (valfritt)</p>

    <div class="devops-connection">
        <div class="form-row-3">
            <div class="form-group">
                <label>Organisation</label>
                <input type="text" @bind="Data.DevOpsOrg" @bind:event="oninput" placeholder="din-org" />
            </div>
            <div class="form-group">
                <label>Projekt</label>
                <input type="text" @bind="Data.DevOpsProject" @bind:event="oninput" placeholder="projektnamn" />
            </div>
            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" @bind="Data.DevOpsPat" @bind:event="oninput" placeholder="PAT med Work Items-scope" />
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(connectionMessage))
        {
            <div class="alert @(connectionSuccess ? "alert-success" : "alert-error")">@connectionMessage</div>
        }

        <div style="display:flex; gap:0.5rem; margin-top:0.5rem">
            <button class="btn btn-outline btn-sm" @onclick="TestConnection"
                    disabled="@(string.IsNullOrWhiteSpace(Data.DevOpsOrg) || string.IsNullOrWhiteSpace(Data.DevOpsProject) || string.IsNullOrWhiteSpace(Data.DevOpsPat) || isTesting)">
                @(isTesting ? "Testar..." : "Testa anslutning")
            </button>
            <button class="btn btn-success" @onclick="PushToDevOps"
                    disabled="@(!connectionSuccess || isPushing)">
                @(isPushing ? "Pushar..." : "Pusha work items")
            </button>
        </div>

        @if (isPushing && pushProgress != null)
        {
            <div style="margin-top:1rem">
                <div class="progress-bar-custom">
                    <div class="progress-fill" style="width: @(pushProgress.Total > 0 ? (int)(100.0 * pushProgress.Current / pushProgress.Total) : 0)%"></div>
                </div>
                <p class="progress-text">@pushProgress.Message (@pushProgress.Current / @pushProgress.Total)</p>
            </div>
        }

        @if (pushResults != null && pushResults.Count > 0)
        {
            <div class="alert alert-success" style="margin-top:1rem">
                Klart! @pushResults.Count work items skapades i Azure DevOps.
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public ProjectData Data { get; set; } = default!;

    private string? connectionMessage;
    private bool connectionSuccess;
    private bool isTesting;
    private bool isPushing;
    private ProgressInfo? pushProgress;
    private List<PushResult>? pushResults;

    private async Task DownloadDevOpsImport()
    {
        var bytes = ExcelService.GenerateDevOpsImport(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"AzureDevopsImportStruktur_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadChecklist()
    {
        var bytes = ExcelService.GenerateChecklist(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Checklista_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadProjektverktyg()
    {
        var bytes = ExcelService.GenerateProjektverktyg(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Projektverktyg_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadAll()
    {
        await DownloadDevOpsImport();
        await Task.Delay(300);
        await DownloadChecklist();
        await Task.Delay(300);
        await DownloadProjektverktyg();
    }

    private async Task TestConnection()
    {
        isTesting = true;
        connectionMessage = null;
        try
        {
            await DevOpsService.TestConnectionAsync(Data.DevOpsOrg, Data.DevOpsProject, Data.DevOpsPat);
            connectionSuccess = true;
            connectionMessage = "Anslutningen lyckades!";
        }
        catch (Exception ex)
        {
            connectionSuccess = false;
            connectionMessage = $"Anslutningen misslyckades: {ex.Message}";
        }
        finally
        {
            isTesting = false;
        }
    }

    private async Task PushToDevOps()
    {
        isPushing = true;
        pushResults = null;
        try
        {
            pushResults = await DevOpsService.PushToDevOpsAsync(Data, progress =>
            {
                pushProgress = progress;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            connectionMessage = $"Fel vid push: {ex.Message}";
            connectionSuccess = false;
        }
        finally
        {
            isPushing = false;
        }
    }
}
