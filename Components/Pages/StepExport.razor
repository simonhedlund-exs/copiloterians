@* Steg 4: Exportera *@
@inject ExcelGeneratorService ExcelService
@inject AzureDevOpsService DevOpsService
@inject IJSRuntime JS

<div class="card">
    <h2>Sammanfattning</h2>
    <p class="subtitle">Granska projektinformationen innan export</p>

    <div class="summary-section">
        <h3>Projektinfo</h3>
        <dl class="summary-grid">
            <dt>Kund</dt><dd>@Data.CustomerName</dd>
            <dt>Projekt</dt><dd>@Data.MainTitle</dd>
            <dt>Area Path</dt><dd>@Data.AreaPath</dd>
            @if (Data.ProjectStart.HasValue)
            {
                <dt>Projektstart</dt><dd>@Data.ProjectStart.Value.ToString("yyyy-MM-dd")</dd>
            }
            @if (Data.GoLive.HasValue)
            {
                <dt>Go-live</dt><dd>@Data.GoLive.Value.ToString("yyyy-MM-dd")</dd>
            }
            <dt>Budget</dt><dd>@Data.BudgetHours h (@Data.EstimatedWeeks veckor)</dd>
        </dl>
    </div>

    <div class="summary-section">
        <h3>Projektgrupp</h3>
        <p>Exsitec: @Data.ExsitecMembers.Count st | Kund: @Data.CustomerMembers.Count st</p>
    </div>

    @if (Data.IncludeRisks)
    {
        <div class="summary-section">
            <h3>Risker</h3>
            <p>@Data.Risks.Count(r => r.Selected) av @Data.Risks.Count risker valda</p>
        </div>
    }

    <div class="summary-section">
        <h3>DevOps-struktur</h3>
        @{
            var totalItems = Data.DevOpsStructure.Epics.Count
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)));
        }
        <p>@Data.DevOpsStructure.Epics.Count Epics, @totalItems totalt work items</p>
    </div>
</div>

<div class="card">
    <h2>Ladda ner CSV-filer</h2>
    <p class="subtitle">Generera CSV-filer f√∂r import eller analys</p>

    <div class="export-grid">
        <div class="export-card">
            <div class="export-icon">üìÑ</div>
            <h3>Work Items CSV</h3>
            <p>Exportera alla work items i CSV-format f√∂r import till DevOps eller andra system</p>
            <button class="btn btn-secondary" @onclick="DownloadWorkItemsCsv">Ladda ner CSV</button>
        </div>
        <div class="export-card">
            <div class="export-icon">üë•</div>
            <h3>Team CSV</h3>
            <p>Exportera projektgruppen som CSV</p>
            <button class="btn btn-secondary" @onclick="DownloadTeamCsv">Ladda ner CSV</button>
        </div>
        @if (Data.IncludeRisks)
        {
            <div class="export-card">
                <div class="export-icon">‚ö†Ô∏è</div>
                <h3>Risker CSV</h3>
                <p>Exportera valda risker som CSV</p>
                <button class="btn btn-secondary" @onclick="DownloadRisksCsv">Ladda ner CSV</button>
            </div>
        }
        <div class="export-card">
            <div class="export-icon">üì¶</div>
            <h3>Alla CSV-filer</h3>
            <p>Ladda ner alla CSV-filer p√• en g√•ng</p>
            <button class="btn btn-primary" @onclick="DownloadAllCsv">Ladda ner alla</button>
        </div>
    </div>
</div>

<div class="card">
    <h2>Ladda ner Excel-filer</h2>
    <p class="subtitle">Generera Excel-dokument baserade p√• dina projektuppgifter</p>

    <div class="export-grid">
        <div class="export-card">
            <div class="export-icon">üìã</div>
            <h3>DevOps Import</h3>
            <p>Importstruktur f√∂r Azure DevOps med alla work items</p>
            <button class="btn btn-secondary" @onclick="DownloadDevOpsImport">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">‚úÖ</div>
            <h3>Checklista</h3>
            <p>Projektchecklista med alla faser och aktiviteter</p>
            <button class="btn btn-secondary" @onclick="DownloadChecklist">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">üìä</div>
            <h3>Projektverktyg</h3>
            <p>Komplett projektverktyg med alla flikar</p>
            <button class="btn btn-secondary" @onclick="DownloadProjektverktyg">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">üì¶</div>
            <h3>Alla filer</h3>
            <p>Ladda ner alla tre Excel-filer p√• en g√•ng</p>
            <button class="btn btn-primary" @onclick="DownloadAll">Ladda ner alla</button>
        </div>
    </div>
</div>

<div class="card">
    <h2>Ladda upp work items till Azure DevOps</h2>
    <p class="subtitle">Skicka alla Epics, Features, Requirements och Tasks direkt till ditt Azure DevOps-projekt</p>

    @if (string.IsNullOrWhiteSpace(Data.DevOpsOrg) || string.IsNullOrWhiteSpace(Data.DevOpsProject) || string.IsNullOrWhiteSpace(Data.DevOpsPat))
    {
        <div class="alert alert-error">
            Du m√•ste ange Organisation, Projektnamn och PAT i steget "Projektinfo" innan du kan importera.
        </div>
    }
    else
    {
        @if (!isImporting && importResults == null)
        {
            <div class="export-grid">
                <div class="export-card">
                    <div class="export-icon">üöÄ</div>
                    <h3>Ladda upp till DevOps</h3>
                    <p>Laddar upp @totalItems work items till <strong>@Data.DevOpsOrg / @Data.DevOpsProject</strong></p>
                    <button class="btn btn-primary" @onclick="ImportToDevOps">Ladda upp work items</button>
                </div>
            </div>
        }

        @if (isImporting && importProgress != null)
        {
            <div style="margin-top:1rem">
                <div class="progress-bar-custom">
                    <div class="progress-fill" style="width: @(importProgress.Total > 0 ? (int)(100.0 * importProgress.Current / importProgress.Total) : 0)%"></div>
                </div>
                <p class="progress-text">@importProgress.Message (@importProgress.Current / @importProgress.Total)</p>
            </div>
        }

        @if (importResults != null)
        {
            <div class="alert alert-success" style="margin-top:1rem">
                <strong>Klart!</strong> @importResults.Count work items skapade i Azure DevOps.
            </div>

            <details style="margin-top:0.5rem">
                <summary style="cursor:pointer; font-weight:600; font-size:0.85rem; color:var(--safir)">
                    Visa skapade work items (@importResults.Count st)
                </summary>
                <table class="data-table" style="margin-top:0.5rem; font-size:0.85rem">
                    <thead><tr><th>Typ</th><th>Titel</th><th>ID</th></tr></thead>
                    <tbody>
                        @foreach (var item in importResults)
                        {
                            <tr>
                                <td><span class="wi-badge wi-@item.Type.ToLower()">@item.Type</span></td>
                                <td>@item.Title</td>
                                <td><a href="https://dev.azure.com/@Data.DevOpsOrg/@Data.DevOpsProject/_workitems/edit/@item.Id" target="_blank">@item.Id</a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </details>

            <div style="margin-top:1rem; display:flex; gap:0.5rem">
                <a href="https://dev.azure.com/@Data.DevOpsOrg/@Data.DevOpsProject/_backlogs" target="_blank" class="btn btn-secondary">
                    √ñppna Backlog i DevOps
                </a>
                <button class="btn btn-outline btn-sm" @onclick="ResetImport">Ladda upp igen</button>
            </div>
        }

        @if (importError != null)
        {
            <div class="alert alert-error" style="margin-top:1rem">
                <strong>Fel:</strong> @importError
            </div>
            <button class="btn btn-outline btn-sm" style="margin-top:0.5rem" @onclick="ResetImport">F√∂rs√∂k igen</button>
        }
    }
</div>

@code {
    [Parameter] public ProjectData Data { get; set; } = default!;

    private bool isImporting;
    private ProgressInfo? importProgress;
    private List<PushResult>? importResults;
    private string? importError;

    private int totalItems => Data.DevOpsStructure.Epics.Count
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))
        + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)));

    private async Task ImportToDevOps()
    {
        isImporting = true;
        importResults = null;
        importError = null;

        try
        {
            importResults = await DevOpsService.PushToDevOpsAsync(Data, p =>
            {
                importProgress = p;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            importError = ex.Message;
        }
        finally
        {
            isImporting = false;
        }
    }

    private void ResetImport()
    {
        importResults = null;
        importProgress = null;
        importError = null;
    }

    // CSV Export methods
    private async Task DownloadWorkItemsCsv()
    {
        var csv = GenerateWorkItemsCsv();
        await DownloadCsvFile($"WorkItems_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadTeamCsv()
    {
        var csv = GenerateTeamCsv();
        await DownloadCsvFile($"Team_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadRisksCsv()
    {
        var csv = GenerateRisksCsv();
        await DownloadCsvFile($"Risker_{Data.CustomerName}.csv", csv);
    }

    private async Task DownloadAllCsv()
    {
        await DownloadWorkItemsCsv();
        await Task.Delay(300);
        await DownloadTeamCsv();
        if (Data.IncludeRisks)
        {
            await Task.Delay(300);
            await DownloadRisksCsv();
        }
    }

    private string GenerateWorkItemsCsv()
    {
        var lines = new List<string> { "Type,Title,Parent,Effort,Estimate" };
        
        foreach (var epic in Data.DevOpsStructure.Epics)
        {
            lines.Add($"Epic,\"{EscapeCsv(epic.Title)}\",,,,");
            foreach (var feature in epic.Features)
            {
                lines.Add($"Feature,\"{EscapeCsv(feature.Title)}\",\"{EscapeCsv(epic.Title)}\",{feature.Effort},");
                foreach (var req in feature.Requirements)
                {
                    lines.Add($"Requirement,\"{EscapeCsv(req.Title)}\",\"{EscapeCsv(feature.Title)}\",,{req.Estimate}");
                    foreach (var task in req.Tasks)
                    {
                        lines.Add($"Task,\"{EscapeCsv(task.Title)}\",\"{EscapeCsv(req.Title)}\",,");
                    }
                }
            }
        }
        
        return string.Join("\n", lines);
    }

    private string GenerateTeamCsv()
    {
        var lines = new List<string> { "Type,Name,Role,Group,Email,Phone,Comment" };
        
        foreach (var member in Data.ExsitecMembers)
        {
            lines.Add($"Exsitec,\"{EscapeCsv(member.Name)}\",\"{EscapeCsv(member.Role)}\",\"{EscapeCsv(member.Group)}\",\"{EscapeCsv(member.Email)}\",\"{EscapeCsv(member.Phone)}\",");
        }
        
        foreach (var member in Data.CustomerMembers)
        {
            lines.Add($"Kund,\"{EscapeCsv(member.Name)}\",\"{EscapeCsv(member.Role)}\",,\"{EscapeCsv(member.Email)}\",\"{EscapeCsv(member.Phone)}\",\"{EscapeCsv(member.Comment)}\"");
        }
        
        return string.Join("\n", lines);
    }

    private string GenerateRisksCsv()
    {
        var lines = new List<string> { "Title,Category,Probability,Impact,RiskValue,Priority,Owner,Strategy" };
        
        foreach (var risk in Data.Risks.Where(r => r.Selected))
        {
            lines.Add($"\"{EscapeCsv(risk.Title)}\",\"{EscapeCsv(risk.Category)}\",{risk.Probability},{risk.Impact},{risk.RiskValue},\"{risk.Priority}\",\"{EscapeCsv(risk.Owner)}\",\"{EscapeCsv(risk.Strategy)}\"");
        }
        
        return string.Join("\n", lines);
    }

    private string EscapeCsv(string? value) => value?.Replace("\"", "\"\"") ?? "";

    private async Task DownloadCsvFile(string filename, string content)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        await JS.InvokeVoidAsync("downloadFile", filename, "text/csv", bytes);
    }

    // Excel Export methods
    private async Task DownloadDevOpsImport()
    {
        var bytes = ExcelService.GenerateDevOpsImport(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"AzureDevopsImportStruktur_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadChecklist()
    {
        var bytes = ExcelService.GenerateChecklist(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Checklista_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadProjektverktyg()
    {
        var bytes = ExcelService.GenerateProjektverktyg(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Projektverktyg_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadAll()
    {
        await DownloadDevOpsImport();
        await Task.Delay(300);
        await DownloadChecklist();
        await Task.Delay(300);
        await DownloadProjektverktyg();
    }
}
