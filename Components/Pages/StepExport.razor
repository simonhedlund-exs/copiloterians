@* Steg 7: Exportera *@
@inject ExcelGeneratorService ExcelService
@inject IJSRuntime JS

<div class="card">
    <h2>Sammanfattning</h2>
    <p class="subtitle">Granska projektinformationen innan export</p>

    <div class="summary-section">
        <h3>Projektinfo</h3>
        <dl class="summary-grid">
            <dt>Kund</dt><dd>@Data.CustomerName</dd>
            <dt>Projekt</dt><dd>@Data.MainTitle</dd>
            <dt>Area Path</dt><dd>@Data.AreaPath</dd>
            @if (Data.ProjectStart.HasValue)
            {
                <dt>Projektstart</dt><dd>@Data.ProjectStart.Value.ToString("yyyy-MM-dd")</dd>
            }
            @if (Data.GoLive.HasValue)
            {
                <dt>Go-live</dt><dd>@Data.GoLive.Value.ToString("yyyy-MM-dd")</dd>
            }
            <dt>Budget</dt><dd>@Data.BudgetHours h (@Data.EstimatedWeeks veckor)</dd>
        </dl>
    </div>

    <div class="summary-section">
        <h3>Projektgrupp</h3>
        <p>Exsitec: @Data.ExsitecMembers.Count st | Kund: @Data.CustomerMembers.Count st</p>
    </div>

    <div class="summary-section">
        <h3>Risker</h3>
        <p>@Data.Risks.Count(r => r.Selected) av @Data.Risks.Count risker valda</p>
    </div>

    <div class="summary-section">
        <h3>DevOps-struktur</h3>
        @{
            var totalItems = Data.DevOpsStructure.Epics.Count
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Count)
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Count))
                + Data.DevOpsStructure.Epics.Sum(e => e.Features.Sum(f => f.Requirements.Sum(r => r.Tasks.Count)));
        }
        <p>@Data.DevOpsStructure.Epics.Count Epics, @totalItems totalt work items</p>
    </div>
</div>

<div class="card">
    <h2>Ladda ner Excel-filer</h2>
    <p class="subtitle">Generera Excel-dokument baserade pÃ¥ dina projektuppgifter</p>

    <div class="export-grid">
        <div class="export-card">
            <div class="export-icon">ðŸ“‹</div>
            <h3>DevOps Import</h3>
            <p>Importstruktur fÃ¶r Azure DevOps med alla work items</p>
            <button class="btn btn-secondary" @onclick="DownloadDevOpsImport">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">âœ…</div>
            <h3>Checklista</h3>
            <p>Projektchecklista med alla faser och aktiviteter</p>
            <button class="btn btn-secondary" @onclick="DownloadChecklist">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">ðŸ“Š</div>
            <h3>Projektverktyg</h3>
            <p>Komplett projektverktyg med alla flikar</p>
            <button class="btn btn-secondary" @onclick="DownloadProjektverktyg">Ladda ner</button>
        </div>
        <div class="export-card">
            <div class="export-icon">ðŸ“¦</div>
            <h3>Alla filer</h3>
            <p>Ladda ner alla tre Excel-filer pÃ¥ en gÃ¥ng</p>
            <button class="btn btn-primary" @onclick="DownloadAll">Ladda ner alla</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public ProjectData Data { get; set; } = default!;

    private async Task DownloadDevOpsImport()
    {
        var bytes = ExcelService.GenerateDevOpsImport(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"AzureDevopsImportStruktur_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadChecklist()
    {
        var bytes = ExcelService.GenerateChecklist(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Checklista_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadProjektverktyg()
    {
        var bytes = ExcelService.GenerateProjektverktyg(Data);
        await JS.InvokeVoidAsync("downloadFile",
            $"Projektverktyg_{Data.CustomerName}.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes);
    }

    private async Task DownloadAll()
    {
        await DownloadDevOpsImport();
        await Task.Delay(300);
        await DownloadChecklist();
        await Task.Delay(300);
        await DownloadProjektverktyg();
    }
}
